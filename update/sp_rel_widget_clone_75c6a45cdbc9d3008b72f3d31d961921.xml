<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_rel_widget_clone">
    <sp_rel_widget_clone action="INSERT_OR_UPDATE">
        <child display_value="EOB Search Nav">f1c6a45cdbc9d3008b72f3d31d96191e</child>
        <cloned>2018-03-20 12:55:41</cloned>
        <last_validated>2018-03-20 12:55:41</last_validated>
        <parent display_value="Search Nav">81299142cb21020000f8d856634c9cc1</parent>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;sp_widget&gt;&lt;category&gt;standard&lt;/category&gt;&lt;client_script/&gt;&lt;controller_as/&gt;&lt;css/&gt;&lt;data_table&gt;sp_instance&lt;/data_table&gt;&lt;demo_data/&gt;&lt;description/&gt;&lt;docs/&gt;&lt;field_list/&gt;&lt;has_preview&gt;false&lt;/has_preview&gt;&lt;id/&gt;&lt;internal&gt;false&lt;/internal&gt;&lt;link/&gt;&lt;name&gt;Search Nav&lt;/name&gt;&lt;option_schema/&gt;&lt;public&gt;true&lt;/public&gt;&lt;roles/&gt;&lt;script&gt;&lt;![CDATA[// populate the 'data' object
data.t = $sp.getParameter('t');
data.q = encodeURIComponent($sp.getParameter('q'));
data.searchSources = [];

//Gotta decide if we want to use the portal's sources, or use the defaults declared by
//the sys property
var useDefaultPortals;
if (!$sp.getPortalRecord()) {
	useDefaultPortals = true;
} else {
	var searchSourcesForPortalGR = new GlideRecord("m2m_sp_portal_search_source");
	searchSourcesForPortalGR.addQuery("sp_portal", $sp.getPortalRecord().getUniqueValue());
	searchSourcesForPortalGR.query();
	useDefaultPortals = searchSourcesForPortalGR.getRowCount() == 0;
}

var userCriteria = new GlideSPUserCriteria();
if (useDefaultPortals) {
	var defaultSearchSourceGR = new GlideRecord("sp_search_source");
	var defaultSearchSourceIDList = gs.getProperty("glide.service_portal.default_search_sources", "");
	defaultSearchSourceGR.addQuery("sys_id", "IN", defaultSearchSourceIDList);
	defaultSearchSourceGR.query();
	while(defaultSearchSourceGR.next()) {
		if (!userCanSeeSearchSource(defaultSearchSourceGR))
			continue;

		data.searchSources.push({
			name: defaultSearchSourceGR.getDisplayValue("name"),
			id: defaultSearchSourceGR.getValue("id"),
			order: defaultSearchSourceIDList.split(",").indexOf(defaultSearchSourceGR.getUniqueValue())
		});
	}
} else {
	var m2mSearchSourceGR = new GlideRecord("m2m_sp_portal_search_source");
	m2mSearchSourceGR.addQuery("sp_portal", $sp.getPortalRecord().getUniqueValue());
	m2mSearchSourceGR.orderBy('order');
	m2mSearchSourceGR.query();
	var index = 0;
	while(m2mSearchSourceGR.next()) {
		var searchSourceGR = m2mSearchSourceGR.getElement("sp_search_source").getRefRecord();

		if (!userCanSeeSearchSource(searchSourceGR))
			continue;

		data.searchSources.push({
			name: searchSourceGR.getDisplayValue("name"),
			id: searchSourceGR.getValue("id"),
			order: index
		});
		index += 1;
	}
}

function userCanSeeSearchSource(sourceGR) {
	if (userCriteria.isEnabled())
		return userCriteria.userCanSeeSearchSource(sourceGR.getUniqueValue());
	else {
		var gs = GlideSession.get();
		var searchSourceRoles = sourceGR.getValue("roles");
		if (searchSourceRoles &amp;&amp; !gs.hasRole(searchSourceRoles))
			return false;

		return true;
	}
}]]&gt;&lt;/script&gt;&lt;servicenow&gt;true&lt;/servicenow&gt;&lt;sys_class_name&gt;sp_widget&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2015-07-30 18:41:58&lt;/sys_created_on&gt;&lt;sys_customer_update&gt;false&lt;/sys_customer_update&gt;&lt;sys_id&gt;81299142cb21020000f8d856634c9cc1&lt;/sys_id&gt;&lt;sys_mod_count&gt;93&lt;/sys_mod_count&gt;&lt;sys_name&gt;Search Nav&lt;/sys_name&gt;&lt;sys_package display_value="Service Portal - Core" source="com.glide.service-portal"&gt;fad771a5dba5fe408838f5e51d961912&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_replace_on_upgrade&gt;false&lt;/sys_replace_on_upgrade&gt;&lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;&lt;sys_update_name&gt;sp_widget_81299142cb21020000f8d856634c9cc1&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2017-08-24 19:11:07&lt;/sys_updated_on&gt;&lt;template&gt;&lt;![CDATA[&lt;h2 class="sr-only"&gt;${Search Categories}&lt;/h2&gt;

&lt;div role="list" class="list-group"&gt;
	  &lt;a role="link" ng-class="{active: !data.t}" class="list-group-item" 
       ng-href="?id=search&amp;q={{data.q}}" aria-label="${All search results}"&gt;
	    &lt;i class="fa fa-chevron-right"/&gt;&lt;span class="m-l-sm"&gt;${All}&lt;/span&gt;
  	&lt;/a&gt;
	  &lt;a role="link" ng-repeat="source in data.searchSources | orderBy:'order'"
	     ng-href="?id=search&amp;t={{source.id}}&amp;q={{data.q}}"
	     ng-class="{active: data.t==source.id}"
	     class="list-group-item" aria-label="{{source.name}} ${Search results}"&gt;
	  	&lt;i class="fa fa-chevron-right"/&gt;&lt;span class="m-l-sm"&gt;{{source.name}}&lt;/span&gt;
  	&lt;/a&gt;
&lt;/div&gt;]]&gt;&lt;/template&gt;&lt;/sp_widget&gt;</payload>
        <sys_class_name>sp_rel_widget_clone</sys_class_name>
        <sys_created_by>rudolf.cronje</sys_created_by>
        <sys_created_on>2018-03-20 12:55:41</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>75c6a45cdbc9d3008b72f3d31d961921</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>f1c6a45cdbc9d3008b72f3d31d96191e</sys_name>
        <sys_package display_value="Electronic Occurence Book" source="engen_eob">f395119e0f230300c23945ace1050e6c</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Electronic Occurence Book">f395119e0f230300c23945ace1050e6c</sys_scope>
        <sys_update_name>sp_rel_widget_clone_75c6a45cdbc9d3008b72f3d31d961921</sys_update_name>
        <sys_updated_by>rudolf.cronje</sys_updated_by>
        <sys_updated_on>2018-03-20 12:55:41</sys_updated_on>
    </sp_rel_widget_clone>
</record_update>
